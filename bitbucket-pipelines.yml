image: node:12.16.3

clone:
  depth: full

installDependencies: &installDependencies
  step:
    name: ğŸ›  Install node modules
    script:
      - yarn
    caches:
      - node

build: &build
  step:
    name: ğŸ›  Build
    caches:
      - node
    script:
      - yarn build

format: &format
  step:
    name: ğŸ§¹ Formatting
    caches:
      - node
    script:
      - yarn format:check

lint: &lint
  step:
    name: ğŸ§¹ Linting
    caches:
      - node
    script:
      - yarn lint

runTests: &runTests
  step:
    name: ğŸ”¬ Tests
    caches:
      - node
    script:
      - yarn test

pipelines:
  pull-requests:
    '**': #this runs as default for any branch not elsewhere defined
      - <<: *installDependencies
      - parallel:
          - <<: *build
          - <<: *format
          - <<: *lint
  branches:
    develop:
      - <<: *installDependencies
      - parallel:
          - <<: *build
          - <<: *format
          - <<: *lint
      - step:
          name: ğŸš€ Deploy to develop
          deployment: develop
          script:
            - git push https://heroku:$HEROKU_API_KEY@git.heroku.com/$HEROKU_APP.git HEAD:master
    staging:
      - <<: *installDependencies
      - parallel:
          - <<: *build
          - <<: *format
          - <<: *lint
      - step:
          name: ğŸš€ Deploy to staging
          deployment: staging
          trigger: manual
          script:
            - git push -f https://heroku:$HEROKU_API_KEY@git.heroku.com/$HEROKU_APP.git HEAD:master
    master:
      - <<: *installDependencies
      - parallel:
          - <<: *build
          - <<: *format
          - <<: *lint
      - step:
          name: ğŸš€ Deploy to production
          deployment: production
          trigger: manual
          script:
            - git push -f https://heroku:$HEROKU_API_KEY@git.heroku.com/$HEROKU_APP.git HEAD:master
